# Автоскуп подарков Telegram (Bot + Userbot)

Этот репозиторий — бот для автоскупа новых подарков в Telegram сразу после выхода. Работает в двух режимах:

- Bot API — покупки осуществляются от имени бота
- Userbot (личный аккаунт через Telethon) — покупки от имени вашего аккаунта, в т.ч. премиум-подарков

Детектор новых подарков основан на базе из проекта https://github.com/arynyklas/tg_gifts_notifier. Всё лишнее удалено, оставлена логика получения/хранения каталога подарков и обёртки для автоскупа.


## Возможности

- Отслеживание появления новых подарков через Pyrogram (`detector.py`)
- Уведомления пользователям бота о новых подарках
- Гибкие ордера по цене/количеству и бюджету
- Автопокупка:
  - через Bot API (по умолчанию)
  - через личный аккаунт (Telethon) — для случаев, когда Bot API не проходит или когда нужны премиум-подарки
- Привязка личного аккаунта в интерфейсе бота
- MongoDB-хранилище пользователей, ордеров и аккаунтов


## Требования

- Python 3.11+
- MongoDB (локально или в облаке)

Установите зависимости:

```bash
pip install -r requirements.txt
```

Примечание: зависимости для детектора — `pyrogram`, `pytz`.


## Конфигурация

Проект использует два конфига: корневой `config.py` и `bot/config.py`.

### Корневой `config.py`
Файл: `config.py`

Поля:
- `SESSION_NAME` — имя сессии Pyrogram для детектора (каталог `sessions/`).
- `API_ID`, `API_HASH` — параметры приложения Telegram для Pyrogram-клиента.
- `CHECK_INTERVAL` — период опроса каталога подарков (сек).
- `TIMEZONE` — таймзона логов (напр. `UTC`).
- `DATA_FILEPATH` — путь к файлу данных подарков (по умолчанию `gifts_data/star_gifts.json`).
- Уровни логирования в консоль/файл.

Где взять `API_ID` и `API_HASH`:
1. Зайдите на https://my.telegram.org
2. Войдите под своим аккаунтом
3. Перейдите в “API Development Tools”
4. Создайте приложение и возьмите `api_id` и `api_hash`

При первом запуске детектора Pyrogram создаст сессию (`sessions/SESSION_NAME.session`) и может запросить телефон/код 2FA в консоли.

### Конфиг бота `bot/config.py`
Файл: `bot/config.py`

Поля:
- `BOT_TOKEN` — токен Telegram-бота (от @BotFather)
- `MONGO_URL` — строка подключения к MongoDB (по умолчанию локально `mongodb://127.0.0.1:27017`)
- `DB_NAME` — имя базы данных (по умолчанию `autoscoop`)
- `TELETHON_API_ID`, `TELETHON_API_HASH` — параметры для Telethon (можно те же, что и в корневом конфиге)
- `DEV_USER_ID` — ваш Telegram ID (админ)
- `TAKE_COMMISSION` — брать ли комиссию с пополнений (если используете только для себя — `False`)


## Запуск

Откройте два терминала в корне проекта.

1) Детектор новых подарков (Pyrogram):
```bash
python detector.py
```
- При первом запуске произойдёт авторизация и создание сессии в каталоге `sessions/`.
- Детектор будет опрашивать каталог подарков и при появлении нового — передаст событие в автоскуп (`autoscoop.process_new_gift_for_autoscoop`).

2) Бот управления и автоскупа (Aiogram):
```bash
python -m bot.main
```
- В Telegram найдите вашего бота, выполните `/start`.
- В меню настроек вы сможете:
  - пополнить баланс
  - создать/включить ордера (цена/лимиты/бюджет/канал назначения)
  - привязать личный аккаунт (Telethon) для персональных покупок


## Как работает покупка

- По событию нового подарка всем пользователям с активными ордерами отправляются уведомления.
- Для каждого пользователя бот проверяет баланс, границы цены/предложения (supply), бюджет ордера и доступные лимиты подарка.
- Покупка выполняется в таком приоритете:
  1. Если подарок премиум — возможна покупка только через личный аккаунт (если привязан и разрешён флаг премиум-покупок).
  2. Если включён режим «только личные покупки» — покупка идёт через Telethon.
  3. Иначе попытка через Bot API. При неудаче (ошибка/ограничения) возможен фолбэк на личный аккаунт, если он подключён и разрешён.
- Все изменения баланса и бюджетов ордеров фиксируются в MongoDB.

Ключевые файлы:
- `detector.py` — запуск Pyrogram-клиента и отслеживание новых подарков
- `autoscoop.py` — логика обработки новых подарков и покупок (Bot API / Telethon)
- `bot/main.py` — точка входа для Aiogram-бота
- `bot/utils/telethon_client.py` — утилиты для привязки и покупок через личный аккаунт


## MongoDB

- По умолчанию используется `MONGO_URL=mongodb://127.0.0.1:27017` и база `autoscoop`.
- Таблицы (коллекции) создаются автоматически при первом обращении.


## Полезные советы

- Держите два процесса (детектор и бот) запущенными одновременно.
- Для премиум-подарков требуется привязанный аккаунт с Telegram Premium.
- Если хотите избегать ограничений Bot API — используйте режим покупок через личный аккаунт.


## Лицензия и благодарности

- База детектора подарков взята из проекта: https://github.com/arynyklas/tg_gifts_notifier
- Автор: @dark_qubit
- Канал: https://t.me/dq_devlog
- Поддержать автора (TON): `UQCqI9aG0_BHHSp7-GMMpJuJ4PH84OdT0T1cl_dbUWifcPys`
